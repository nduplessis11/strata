name: build

on:
  push:
    branches: ["master"]
    tags: ["v*"]
  pull_request:
    branches: ["master"]

# Needed for creating Releases (tag pushes). Safe to keep for PRs.
permissions:
  contents: write

jobs:
  build-windows:
    name: windows (Release) + publish
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Vulkan SDK (PINNED; known-good layout for CI) ----
      - name: Install Vulkan SDK
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true

      - name: Sanity check Vulkan SDK layout (Windows)
        shell: bash
        run: |
          echo "VULKAN_SDK=$VULKAN_SDK"
          ls -la "$VULKAN_SDK" || true
          test -f "$VULKAN_SDK/Include/vulkan/vulkan.h"
          test -f "$VULKAN_SDK/Lib/vulkan-1.lib"

          # Make shader tools available if your build uses them
          echo "$VULKAN_SDK/Bin" >> "$GITHUB_PATH"
          echo "$VULKAN_SDK/bin" >> "$GITHUB_PATH"

      # ---- Configure / Build / Test ----
      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S "$env:GITHUB_WORKSPACE" -B "$env:GITHUB_WORKSPACE\build"

      - name: Build (Release)
        shell: pwsh
        run: |
          cmake --build "$env:GITHUB_WORKSPACE\build" --config Release --parallel

      - name: Test (Release)
        shell: pwsh
        run: |
          ctest --test-dir "$env:GITHUB_WORKSPACE\build" --build-config Release --output-on-failure

      # ---- Stage files to publish ----
      - name: Stage arcade shooter dist
        id: stage
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build"
          $distDir  = Join-Path $env:GITHUB_WORKSPACE "dist"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null

          # Find arcade shooter EXE (current target output name)
          $exe = Get-ChildItem -Path $buildDir -Recurse -File -Filter "strata_shooter.exe" | Select-Object -First 1
          if (-not $exe) { throw "Could not find strata_shooter.exe under $buildDir" }

          # Publish name (you can keep strata_shooter.exe if you prefer)
          Copy-Item $exe.FullName (Join-Path $distDir "arcade_shooter.exe") -Force

          # Optional: include PDB if present
          $pdbPath = [System.IO.Path]::ChangeExtension($exe.FullName, ".pdb")
          if (Test-Path $pdbPath) { Copy-Item $pdbPath $distDir -Force }

          # Shaders: safest is the shaders folder next to the EXE output
          $exeDir    = $exe.Directory.FullName
          $shaderDir = Join-Path $exeDir "shaders"
          if (Test-Path $shaderDir) {
            Copy-Item $shaderDir (Join-Path $distDir "shaders") -Recurse -Force
          } else {
            Write-Host "::warning::No shaders folder found next to exe at $shaderDir. If runtime needs shaders, ensure your post-build copy step runs in CI."
          }

          "distDir=$distDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      # ---- 1) Upload as Actions artifact (always) ----
      - name: Upload artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: arcade_shooter-windows-Release
          path: ${{ steps.stage.outputs.distDir }}
          if-no-files-found: error
          retention-days: 14

      # ---- 2) Publish to GitHub Releases (only on tag pushes) ----
      - name: Zip release payload
        if: github.ref_type == 'tag'
        shell: pwsh
        run: |
          $zip = Join-Path $env:GITHUB_WORKSPACE ("arcade_shooter-" + "${{ github.ref_name }}" + "-windows.zip")
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path (Join-Path $env:GITHUB_WORKSPACE "dist\*") -DestinationPath $zip

      - name: Create/Update GitHub Release + upload asset
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/arcade_shooter-${{ github.ref_name }}-windows.zip
          generate_release_notes: true

  build-linux-x11:
    name: linux (X11, Release)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (X11 + build tooling)
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build pkg-config \
            xorg-dev libgl1-mesa-dev \
            xvfb zip

      # ---- Vulkan SDK (PINNED; same as Windows) ----
      - name: Install Vulkan SDK
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true

      - name: Sanity check Vulkan SDK layout (Linux)
        shell: bash
        run: |
          echo "VULKAN_SDK=$VULKAN_SDK"
          ls -la "$VULKAN_SDK" || true
          # SDK layout differs a bit by platform; accept either casing.
          test -f "$VULKAN_SDK/include/vulkan/vulkan.h" || test -f "$VULKAN_SDK/Include/vulkan/vulkan.h"

      # ---- Configure / Build / Test ----
      - name: Configure CMake (Release)
        shell: bash
        run: |
          cmake -S "$GITHUB_WORKSPACE" -B "$GITHUB_WORKSPACE/build" -DCMAKE_BUILD_TYPE=Release

      - name: Build (Release)
        shell: bash
        run: |
          cmake --build "$GITHUB_WORKSPACE/build" --parallel

      - name: Test (Release, Xvfb)
        shell: bash
        run: |
          xvfb-run -a ctest --test-dir "$GITHUB_WORKSPACE/build" -C Release --output-on-failure

      # ---- Stage files to publish ----
      - name: Stage arcade shooter dist
        id: stage
        shell: bash
        run: |
          buildDir="$GITHUB_WORKSPACE/build"
          distDir="$GITHUB_WORKSPACE/dist"
          mkdir -p "$distDir"

          # Find Linux executable (expected output name)
          exe="$(find "$buildDir" -type f -name "strata_shooter" -perm -111 | head -n 1 || true)"
          if [ -z "$exe" ]; then
            exe="$(find "$buildDir" -type f -name "strata_shooter" | head -n 1 || true)"
          fi
          if [ -z "$exe" ]; then
            echo "Could not find strata_shooter under $buildDir"
            echo "Here are some files near the build root to help debug:"
            find "$buildDir" -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          cp -f "$exe" "$distDir/arcade_shooter"
          chmod +x "$distDir/arcade_shooter"

          # Shaders: prefer folder next to the executable; fall back to repo root /shaders if present
          shaderDir="$(dirname "$exe")/shaders"
          if [ -d "$shaderDir" ]; then
            cp -R "$shaderDir" "$distDir/shaders"
          elif [ -d "$GITHUB_WORKSPACE/shaders" ]; then
            cp -R "$GITHUB_WORKSPACE/shaders" "$distDir/shaders"
          else
            echo "::warning::No shaders folder found. If runtime needs shaders, ensure your post-build copy step runs in CI."
          fi

          echo "distDir=$distDir" >> "$GITHUB_OUTPUT"

      # ---- 1) Upload as Actions artifact (always) ----
      - name: Upload artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: arcade_shooter-linux-x11-Release
          path: ${{ steps.stage.outputs.distDir }}
          if-no-files-found: error
          retention-days: 14

  publish-linux-x11:
    name: linux (X11) publish to GitHub Release
    if: github.ref_type == 'tag'
    runs-on: ubuntu-24.04
    needs: [build-windows, build-linux-x11]

    steps:
      - name: Install zip
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends zip

      - name: Download linux artifact
        uses: actions/download-artifact@v4
        with:
          name: arcade_shooter-linux-x11-Release
          path: dist

      - name: Zip release payload (Linux X11)
        shell: bash
        run: |
          zipPath="$GITHUB_WORKSPACE/arcade_shooter-${{ github.ref_name }}-linux-x11.zip"
          rm -f "$zipPath"
          (cd "$GITHUB_WORKSPACE/dist" && zip -r "$zipPath" .)

      - name: Upload asset to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/arcade_shooter-${{ github.ref_name }}-linux-x11.zip
