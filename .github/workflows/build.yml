name: build

on:
  push:
  pull_request:

jobs:
  build:
    name: build (${{ matrix.os }}, ${{ matrix.build_type }}, ${{ matrix.c_compiler }}, ${{ matrix.cpp_compiler }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            build_type: Release
            c_compiler: cl
            cpp_compiler: cl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Linux prerequisites (X11 headers + Ninja is commonly needed for CMake builds)
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libx11-dev

      # Vulkan SDK (PINNED)
      #
      # The action docs list 1.4.309.0 as a known-working cross-platform version.
      # Using "latest" can resolve to a newer SDK that this action's unpacking path
      # doesn't lay out with Include/Lib on Windows runners.
      - name: Install Vulkan SDK
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true

      # Fail fast if the SDK layout isn't what CMake expects
      - name: Sanity check Vulkan SDK layout
        shell: bash
        run: |
          echo "VULKAN_SDK=$VULKAN_SDK"
          ls -la "$VULKAN_SDK" || true

          if [[ "$RUNNER_OS" == "Windows" ]]; then
            test -f "$VULKAN_SDK/Include/vulkan/vulkan.h"
            test -f "$VULKAN_SDK/Lib/vulkan-1.lib"
          else
            test -f "$VULKAN_SDK/include/vulkan/vulkan.h"
            # just show what we have; loader names/paths can vary a bit
            ls -la "$VULKAN_SDK/lib" || true
          fi

      # Configure
      # - Windows: default generator is Visual Studio (multi-config), so CMAKE_BUILD_TYPE is ignored.
      # - Linux: use Ninja + CMAKE_BUILD_TYPE.
      - name: Configure (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cmake -S . -B build \
            -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}

      - name: Configure (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}

      # Build
      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cmake --build build --config ${{ matrix.build_type }} --parallel

      - name: Build (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          cmake --build build --parallel
