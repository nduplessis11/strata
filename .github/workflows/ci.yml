name: Build (Windows) + Publish Artifact

on:
  push:
    branches: [ "master" ]
    tags: [ "v*" ]         # tag pushes like v0.1.0 will also publish a Release asset
  pull_request:
    branches: [ "master" ]

# Needed only for creating Releases (safe to leave here; PRs won't create releases anyway)
permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # --- Configure / Build / Test ---
      - name: Configure CMake
        run: >
          cmake -B "${{ github.workspace }}/build"
          -S "${{ github.workspace }}"

      - name: Build (Release)
        run: cmake --build "${{ github.workspace }}/build" --config Release --parallel

      - name: Test (Release)
        run: ctest --test-dir "${{ github.workspace }}/build" --build-config Release --output-on-failure

      # --- Stage files we want to publish ---
      - name: Stage arcade shooter dist
        id: stage
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build"
          $distDir  = Join-Path $env:GITHUB_WORKSPACE "dist"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null

          # Find the EXE
          $exe = Get-ChildItem -Path $buildDir -Recurse -File -Filter "strata_shooter.exe" | Select-Object -First 1
          if (-not $exe) { throw "Could not find strata_shooter.exe under $buildDir" }

          Copy-Item $exe.FullName $distDir -Force

          # Optional: include PDB if present
          $pdb = Get-ChildItem -Path $buildDir -Recurse -File -Filter "strata_shooter.pdb" | Select-Object -First 1
          if ($pdb) { Copy-Item $pdb.FullName $distDir -Force }

          # Include compiled shaders if they exist
          $shaderDir = Join-Path $buildDir "engine\gfx\renderer\shaders"
          if (Test-Path $shaderDir) {
            Copy-Item $shaderDir (Join-Path $distDir "shaders") -Recurse -Force
          } else {
            Write-Host "::warning::Shader directory not found at $shaderDir (if your exe needs shaders at runtime, fix the staging path)."
          }

          "distDir=$distDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      # --- 1) Publish to Actions as an Artifact (always) ---
      - name: Upload artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: arcade_shooter-windows-Release
          path: ${{ steps.stage.outputs.distDir }}
          if-no-files-found: error
          retention-days: 14
        # upload-artifact supports if-no-files-found + retention-days inputs.

      # --- 2) Publish to GitHub Releases (only on tag pushes) ---
      - name: Zip release payload
        if: github.ref_type == 'tag'
        shell: pwsh
        run: |
          $zip = Join-Path $env:GITHUB_WORKSPACE ("arcade_shooter-" + "${{ github.ref_name }}" + "-windows.zip")
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path (Join-Path $env:GITHUB_WORKSPACE "dist\*") -DestinationPath $zip
          "zipPath=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create/Update GitHub Release + upload asset
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/arcade_shooter-${{ github.ref_name }}-windows.zip
        # action-gh-release uses with.files to upload assets and recommends tag gating
