name: build

on:
  push:
    branches: ["master"]
    tags: ["v*"]
  pull_request:
    branches: ["master"]

permissions:
  contents: write

jobs:
  build-windows:
    name: windows (Release) + publish
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- Vulkan SDK (PINNED; known-good layout for CI) ----
      - name: Install Vulkan SDK
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true

      - name: Sanity check Vulkan SDK layout (Windows)
        shell: bash
        run: |
          echo "VULKAN_SDK=$VULKAN_SDK"
          ls -la "$VULKAN_SDK" || true
          test -f "$VULKAN_SDK/Include/vulkan/vulkan.h"
          test -f "$VULKAN_SDK/Lib/vulkan-1.lib"

          echo "$VULKAN_SDK/Bin" >> "$GITHUB_PATH"
          echo "$VULKAN_SDK/bin" >> "$GITHUB_PATH"

      # ---- Configure / Build / Test ----
      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S "$env:GITHUB_WORKSPACE" -B "$env:GITHUB_WORKSPACE\build" `
            -DCMAKE_CXX_STANDARD=23 `
            -DCMAKE_CXX_STANDARD_REQUIRED=ON `
            -DCMAKE_CXX_EXTENSIONS=OFF

      - name: Build (Release)
        shell: pwsh
        run: |
          cmake --build "$env:GITHUB_WORKSPACE\build" --config Release --parallel

      - name: Test (Release)
        shell: pwsh
        run: |
          ctest --test-dir "$env:GITHUB_WORKSPACE\build" --build-config Release --output-on-failure

      # ----------------------------------------------------------------------------
      # Stage: arcade shooter
      # ----------------------------------------------------------------------------
      - name: Stage arcade shooter dist
        id: stage_shooter
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build"
          $distRoot = Join-Path $env:GITHUB_WORKSPACE "dist"
          $distDir  = Join-Path $distRoot "arcade_shooter"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null

          $exe = Get-ChildItem -Path $buildDir -Recurse -File -Filter "strata_shooter.exe" | Select-Object -First 1
          if (-not $exe) { throw "Could not find strata_shooter.exe under $buildDir" }

          Copy-Item $exe.FullName (Join-Path $distDir "arcade_shooter.exe") -Force

          $pdbPath = [System.IO.Path]::ChangeExtension($exe.FullName, ".pdb")
          if (Test-Path $pdbPath) { Copy-Item $pdbPath $distDir -Force }

          $exeDir    = $exe.Directory.FullName
          $shaderDir = Join-Path $exeDir "shaders"
          if (Test-Path $shaderDir) {
            Copy-Item $shaderDir (Join-Path $distDir "shaders") -Recurse -Force
          } else {
            Write-Host "::warning::No shaders folder found next to shooter exe at $shaderDir."
          }

          "distDir=$distDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Upload artifact (Actions) - arcade shooter
        uses: actions/upload-artifact@v4
        with:
          name: arcade_shooter-windows-Release
          path: ${{ steps.stage_shooter.outputs.distDir }}
          if-no-files-found: error
          retention-days: 14

      # ----------------------------------------------------------------------------
      # Stage: level editor
      # ----------------------------------------------------------------------------
      - name: Stage level editor dist
        id: stage_editor
        shell: pwsh
        run: |
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "build"
          $distRoot = Join-Path $env:GITHUB_WORKSPACE "dist"
          $distDir  = Join-Path $distRoot "level_editor"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null

          $exe = Get-ChildItem -Path $buildDir -Recurse -File -Filter "strata_level_editor.exe" | Select-Object -First 1
          if (-not $exe) { throw "Could not find strata_level_editor.exe under $buildDir (did you add add_subdirectory(tools/level_editor) to root CMakeLists.txt?)" }

          Copy-Item $exe.FullName (Join-Path $distDir "level_editor.exe") -Force

          $pdbPath = [System.IO.Path]::ChangeExtension($exe.FullName, ".pdb")
          if (Test-Path $pdbPath) { Copy-Item $pdbPath $distDir -Force }

          # Shaders: your editor target POST_BUILD copies them next to the exe
          $exeDir    = $exe.Directory.FullName
          $shaderDir = Join-Path $exeDir "shaders"
          if (Test-Path $shaderDir) {
            Copy-Item $shaderDir (Join-Path $distDir "shaders") -Recurse -Force
          } else {
            Write-Host "::warning::No shaders folder found next to editor exe at $shaderDir. Ensure the POST_BUILD copy_directory runs in CI."
          }

          "distDir=$distDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Upload artifact (Actions) - level editor
        uses: actions/upload-artifact@v4
        with:
          name: level_editor-windows-Release
          path: ${{ steps.stage_editor.outputs.distDir }}
          if-no-files-found: error
          retention-days: 14

      # ---- Publish to GitHub Releases (only on tag pushes) ----
      - name: Zip release payloads (Windows)
        if: github.ref_type == 'tag'
        shell: pwsh
        run: |
          $zipShooter = Join-Path $env:GITHUB_WORKSPACE ("arcade_shooter-" + "${{ github.ref_name }}" + "-windows.zip")
          $zipEditor  = Join-Path $env:GITHUB_WORKSPACE ("level_editor-" + "${{ github.ref_name }}" + "-windows.zip")

          if (Test-Path $zipShooter) { Remove-Item $zipShooter -Force }
          if (Test-Path $zipEditor)  { Remove-Item $zipEditor  -Force }

          Compress-Archive -Path (Join-Path $env:GITHUB_WORKSPACE "dist\arcade_shooter\*") -DestinationPath $zipShooter
          Compress-Archive -Path (Join-Path $env:GITHUB_WORKSPACE "dist\level_editor\*")   -DestinationPath $zipEditor

      - name: Create/Update GitHub Release + upload assets (Windows)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/arcade_shooter-${{ github.ref_name }}-windows.zip
            ${{ github.workspace }}/level_editor-${{ github.ref_name }}-windows.zip
          generate_release_notes: true

  build-linux-x11:
    name: linux (X11, Release)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (X11 + build tooling + GCC 14 for C++23 <print>)
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build pkg-config \
            xorg-dev libgl1-mesa-dev \
            xvfb zip \
            gcc-14 g++-14

          echo "gcc-14: $(gcc-14 --version | head -n 1)"
          echo "g++-14: $(g++-14 --version | head -n 1)"

      - name: Install Vulkan SDK
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true

      - name: Sanity check Vulkan SDK layout (Linux)
        shell: bash
        run: |
          echo "VULKAN_SDK=$VULKAN_SDK"
          ls -la "$VULKAN_SDK" || true
          test -f "$VULKAN_SDK/include/vulkan/vulkan.h" || test -f "$VULKAN_SDK/Include/vulkan/vulkan.h"

      # ---- Configure / Build / Test ----
      - name: Configure CMake (Release, C++23)
        shell: bash
        run: |
          cmake -S "$GITHUB_WORKSPACE" -B "$GITHUB_WORKSPACE/build" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DCMAKE_CXX_EXTENSIONS=OFF

          echo "---- CMake toolchain summary ----"
          grep -E "CMAKE_(C|CXX)_COMPILER:FILEPATH=|CMAKE_CXX_STANDARD:STRING=" "$GITHUB_WORKSPACE/build/CMakeCache.txt" || true

      - name: Build (Release)
        shell: bash
        run: |
          cmake --build "$GITHUB_WORKSPACE/build" --parallel

      - name: Test (Release, Xvfb)
        shell: bash
        run: |
          xvfb-run -a ctest --test-dir "$GITHUB_WORKSPACE/build" -C Release --output-on-failure

      # ----------------------------------------------------------------------------
      # Stage: arcade shooter
      # ----------------------------------------------------------------------------
      - name: Stage arcade shooter dist
        id: stage_shooter
        shell: bash
        run: |
          buildDir="$GITHUB_WORKSPACE/build"
          distDir="$GITHUB_WORKSPACE/dist/arcade_shooter"
          mkdir -p "$distDir"

          exe="$(find "$buildDir" -type f -name "strata_shooter" -perm -111 | head -n 1 || true)"
          if [ -z "$exe" ]; then
            exe="$(find "$buildDir" -type f -name "strata_shooter" | head -n 1 || true)"
          fi
          if [ -z "$exe" ]; then
            echo "Could not find strata_shooter under $buildDir"
            find "$buildDir" -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          cp -f "$exe" "$distDir/arcade_shooter"
          chmod +x "$distDir/arcade_shooter"

          shaderDir="$(dirname "$exe")/shaders"
          if [ -d "$shaderDir" ]; then
            cp -R "$shaderDir" "$distDir/shaders"
          else
            echo "::warning::No shaders folder found next to shooter exe at $shaderDir."
          fi

          echo "distDir=$distDir" >> "$GITHUB_OUTPUT"

      - name: Upload artifact (Actions) - arcade shooter
        uses: actions/upload-artifact@v4
        with:
          name: arcade_shooter-linux-x11-Release
          path: ${{ steps.stage_shooter.outputs.distDir }}
          if-no-files-found: error
          retention-days: 14

      # ----------------------------------------------------------------------------
      # Stage: level editor
      # ----------------------------------------------------------------------------
      - name: Stage level editor dist
        id: stage_editor
        shell: bash
        run: |
          buildDir="$GITHUB_WORKSPACE/build"
          distDir="$GITHUB_WORKSPACE/dist/level_editor"
          mkdir -p "$distDir"

          exe="$(find "$buildDir" -type f -name "strata_level_editor" -perm -111 | head -n 1 || true)"
          if [ -z "$exe" ]; then
            exe="$(find "$buildDir" -type f -name "strata_level_editor" | head -n 1 || true)"
          fi
          if [ -z "$exe" ]; then
            echo "Could not find strata_level_editor under $buildDir (did you add add_subdirectory(tools/level_editor)?)"
            find "$buildDir" -maxdepth 5 -type f | head -n 250
            exit 1
          fi

          cp -f "$exe" "$distDir/level_editor"
          chmod +x "$distDir/level_editor"

          # Shaders: your editor target POST_BUILD copies them next to the exe
          shaderDir="$(dirname "$exe")/shaders"
          if [ -d "$shaderDir" ]; then
            cp -R "$shaderDir" "$distDir/shaders"
          else
            echo "::warning::No shaders folder found next to editor exe at $shaderDir. Ensure POST_BUILD copy_directory runs in CI."
          fi

          echo "distDir=$distDir" >> "$GITHUB_OUTPUT"

      - name: Upload artifact (Actions) - level editor
        uses: actions/upload-artifact@v4
        with:
          name: level_editor-linux-x11-Release
          path: ${{ steps.stage_editor.outputs.distDir }}
          if-no-files-found: error
          retention-days: 14

  publish-linux-x11:
    name: linux (X11) publish to GitHub Release
    if: github.ref_type == 'tag'
    runs-on: ubuntu-24.04
    needs: [build-windows, build-linux-x11]

    steps:
      - name: Install zip
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends zip

      - name: Download linux shooter artifact
        uses: actions/download-artifact@v4
        with:
          name: arcade_shooter-linux-x11-Release
          path: dist/arcade_shooter

      - name: Download linux editor artifact
        uses: actions/download-artifact@v4
        with:
          name: level_editor-linux-x11-Release
          path: dist/level_editor

      - name: Zip release payloads (Linux X11)
        shell: bash
        run: |
          zipShooter="$GITHUB_WORKSPACE/arcade_shooter-${{ github.ref_name }}-linux-x11.zip"
          zipEditor="$GITHUB_WORKSPACE/level_editor-${{ github.ref_name }}-linux-x11.zip"

          rm -f "$zipShooter" "$zipEditor"

          (cd "$GITHUB_WORKSPACE/dist/arcade_shooter" && zip -r "$zipShooter" .)
          (cd "$GITHUB_WORKSPACE/dist/level_editor"  && zip -r "$zipEditor"  .)

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/arcade_shooter-${{ github.ref_name }}-linux-x11.zip
            ${{ github.workspace }}/level_editor-${{ github.ref_name }}-linux-x11.zip
